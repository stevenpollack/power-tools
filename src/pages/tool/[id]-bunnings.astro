---
import Layout from "../../layouts/ReviewLayout.astro";
import { getCollection, getEntry } from "astro:content";
import { Picture } from "astro:assets";
import type { ReviewWithData, Tool } from "@/lib/types";
import { ExternalLink } from "lucide-react";

// Import new Bunnings components
import ToolFeatures from "../../components/bunnings/tool-features.astro";
import ToolSpecifications from "../../components/bunnings/tool-specifications.astro";
import {
  AccordionItem,
  AccordionTrigger,
  AccordionContent,
} from "../../components/ui/accordion";
import { ReviewsSection } from "../../components/reviews/reviews-section";

export async function getStaticPaths() {
  const tools = await getCollection("tools");

  return tools.map((tool) => ({
    params: { id: tool.id },
    props: { tool },
  }));
}

const { tool }: { tool: Tool } = Astro.props;

// Get reviews for this tool
const reviews = (await getCollection("reviews")).filter(
  (review) => review.data.tool.id === tool.id,
);

// Get author data for each review
const reviewsWithData: ReviewWithData[] = await Promise.all(
  reviews.map(async (review) => ({
    review,
    author: await getEntry(review.data.author),
    tool,
  })),
);

// Calculate review statistics
const totalReviews = reviewsWithData.length;
const averageRating =
  totalReviews > 0
    ? reviewsWithData.reduce((sum, r) => sum + (r.review.data.rating || 0), 0) /
      totalReviews
    : 0;

const ratingDistribution = reviewsWithData.reduce(
  (dist, r) => {
    const rating = r.review.data.rating || 3;
    dist[rating as keyof typeof dist] =
      (dist[rating as keyof typeof dist] || 0) + 1;
    return dist;
  },
  { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
);

const averageQualityRating =
  totalReviews > 0
    ? reviewsWithData.reduce(
        (sum, r) => sum + (r.review.data.qualityRating || 0),
        0,
      ) / totalReviews
    : 0;

const averageValueRating =
  totalReviews > 0
    ? reviewsWithData.reduce(
        (sum, r) => sum + (r.review.data.valueRating || 0),
        0,
      ) / totalReviews
    : 0;

// Transform reviews for the component
const transformedReviews = reviewsWithData.slice(0, 6).map((r) => ({
  rating: r.review.data.rating || 3,
  recommendsProduct: r.review.data.recommendsProduct || true,
  helpfulVotes: r.review.data.helpfulVotes || 0,
  unhelpfulVotes: r.review.data.unhelpfulVotes || 0,
  verifiedPurchaser: r.review.data.verifiedPurchaser || true,
  displayName:
    r.review.data.displayName ||
    r.author.data.displayName ||
    r.author.data.name,
  useCase: r.review.data.useCase || "General use",
  userCategory: r.review.data.userCategory || "DIY Enthusiast",
  content: r.review.data.excerpt || "Great tool!",
  dateCreated: r.review.data.dateCreated,
  qualityRating: r.review.data.qualityRating || 4,
  valueRating: r.review.data.valueRating || 4,
}));

const { name, brand, specifications, pricing } = tool.data;
---

<Layout title={`${name} - Reviews`}>
  <main class="bunnings-tool-page">
    <!-- Tool Header Section -->
    <div class="tool-header-section">
      <div class="container">
        <div class="tool-header">
          <div class="tool-image">
            <Picture
              src={tool.data.thumbnailUrl}
              alt={name}
              class="tool-image-img"
              widths={[300, 600]}
              sizes="(max-width: 768px) 250px, 300px"
            />
          </div>

          <div class="tool-info">
            <h1 class="tool-title">{name}</h1>
            <p class="tool-brand">{brand}</p>

            <div class="tool-price">
              <span class="current-price">${pricing.currentPrice}</span>
              {
                pricing.onSale && pricing.msrp && (
                  <span class="original-price">${pricing.msrp}</span>
                )
              }
            </div>

            {
              tool.data.bunningsUrl && (
                <div class="tool-links">
                  <a
                    href={tool.data.bunningsUrl}
                    class="bunnings-link"
                    target="_blank"
                  >
                    <span class="link-content">
                      View on Bunnings.com.au
                      <ExternalLink className="external-icon" />
                    </span>
                  </a>
                </div>
              )
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Bunnings-style Accordion Sections -->
    <div class="bunnings-sections">
      <div class="container">
        <!-- Features Section -->
        <AccordionItem defaultOpen={true}>
          <AccordionTrigger>Features</AccordionTrigger>
          <AccordionContent>
            <ToolFeatures
              features={specifications.keyFeatures}
              description="Key features and capabilities of this tool."
            />
          </AccordionContent>
        </AccordionItem>

        <!-- Specifications Section -->
        <AccordionItem>
          <AccordionTrigger>Specifications</AccordionTrigger>
          <AccordionContent>
            <ToolSpecifications specifications={specifications} />
          </AccordionContent>
        </AccordionItem>

        <!-- Ratings & Reviews Section -->
        <AccordionItem>
          <AccordionTrigger>Ratings & Reviews</AccordionTrigger>
          <AccordionContent>
            <ReviewsSection
              client:load
              reviews={transformedReviews}
              totalReviews={totalReviews}
              averageRating={averageRating}
              ratingDistribution={ratingDistribution}
              averageQualityRating={averageQualityRating}
              averageValueRating={averageValueRating}
            />
          </AccordionContent>
        </AccordionItem>
      </div>
    </div>
  </main>
</Layout>

<style>
  .bunnings-tool-page {
    min-height: 100vh;
    background-color: white;
  }

  .container {
    max-width: 72rem;
    margin-left: auto;
    margin-right: auto;
    padding-left: 1rem;
    padding-right: 1rem;
  }

  @media (min-width: 640px) {
    .container {
      padding-left: 1.5rem;
      padding-right: 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .container {
      padding-left: 2rem;
      padding-right: 2rem;
    }
  }

  /* Tool Header Section */
  .tool-header-section {
    background-color: white;
    padding-top: 1.5rem;
    padding-bottom: 1.5rem;
  }

  @media (min-width: 640px) {
    .tool-header-section {
      padding-top: 2rem;
      padding-bottom: 2rem;
    }
  }

  .tool-header {
    @apply grid gap-6 lg:grid-cols-2 lg:gap-12;
  }

  .tool-image {
    @apply flex justify-center lg:justify-start;
  }

  .tool-image-img {
    @apply h-64 w-64 rounded-lg border object-cover sm:h-80 sm:w-80 lg:h-96 lg:w-96;
  }

  .tool-info {
    @apply space-y-4 text-center lg:text-left;
  }

  .tool-title {
    @apply font-bunnings-heading text-bunnings-2xl text-bunnings-primary-green font-bold lg:text-3xl;
  }

  .tool-brand {
    @apply text-bunnings-xl text-bunnings-neutral-dark-gray font-medium;
  }

  .tool-price {
    @apply flex flex-col items-center gap-2 sm:flex-row lg:items-start;
  }

  .current-price {
    @apply text-bunnings-primary-green text-2xl font-bold sm:text-3xl;
  }

  .original-price {
    @apply text-bunnings-base text-bunnings-neutral-dark-gray line-through;
  }

  .tool-links {
    @apply mt-4;
  }

  .bunnings-link {
    @apply bg-bunnings-primary-orange hover:bg-bunnings-primary-orange/90 inline-flex items-center rounded-md px-6 py-3 font-medium text-white transition-colors;
  }

  .link-content {
    @apply flex items-center gap-2;
  }

  .external-icon {
    @apply h-4 w-4;
  }

  /* Bunnings Sections */
  .bunnings-sections {
    background-color: rgb(245, 245, 245);
    padding-top: 2rem;
    padding-bottom: 2rem;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .tool-header {
      @apply grid-cols-1 gap-4;
    }

    .tool-image-img {
      @apply h-48 w-48;
    }

    .tool-title {
      @apply text-bunnings-xl;
    }

    .tool-brand {
      @apply text-bunnings-base;
    }

    .current-price {
      @apply text-xl;
    }
  }
</style>
